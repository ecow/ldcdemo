<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type">
    <title>Context package documentation</title>
    <link rel="stylesheet" type="text/css" href="http://ontology.it/tools/bofw/v4/css/doc.css">
  </head>
  <body>
    <header>
      <div class="jumbotron">
        <h1>Context package</h1>
        <p id="subject"> Ultraligth validation and sanitization for RESTful APIs. </p>
      </div>
      <div class="metadata">
        <dl>
          <!-- __METADATA --> <dt>Author:</dt>
          <dd id="creator">
            <address> Enrico Fagnoni - <a href="http://www.e-artspace.com/home/about">E-Artspace</a> </address>
          </dd>
        </dl>
      </div>
      <section id="abstract">
        <h2>Abstract</h2>
        <p> This package exports a set of class to manage the context of a RESTful request. </p>
        <p> A Context is defined as the full set of variables available runtime durin the serving of an http request.
          Variables are grouped in distinct name spaces. </p>
        <p> All variables in name spaces are <strong>read only</strong>. </p>
        <p> This package exposes the methods to sanitize and validate context variables. </p>
        <p> Note that cookies and session aren't part of context. This because proper RESTful resource implementation
          shouldn't need persisten status in any way. </p>
      </section>
      <section id="license">
        <h2>License</h2>
        <details> <summary id="rightsHolder"> Copyright © 2013 by <a href="http://www.e.artspace.com/">E-Artspace
              S.r.L.</a><sup>®</sup> GPL-3.0+ </summary>
          <p> This code is free software; you can redistribute it and/or modify it under the terms of the <a href="http://www.gnu.org/licenses/gpl.html">GNU
              General Public License</a> as published by the Free Software Foundation; either version 3.0of the License,
            or (at your option) any later version. This code is distributed in the hope that it will be useful,but
            WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
            PURPOSE. See the GNU General Public License for more details. </p>
          <p> <strong>For commercial license or others license schema, please contact <a href="http://www.e-artspace.com/">E-Artspace</a>
              or authors. </strong> </p>
        </details> </section>
    </header>
    <nav>
      <h2>Table of contents</h2>
      <!-- autogenerated toc-->
      <div id="toc"> </div>
    </nav>
    <section>
      <h1 id="install">Installation</h1>
      <p> This package follows<a href="../overview/#installation"> BOTK guide line for installation</a> and require <a
          href="http://getcomposer.org/">composer</a>. </p>
      <p>Add following dependances to <strong>composer.json</strong> file in your project root: </p>
      <pre><code>{
    "require": {
        "botk/context": "*"
    }
}</code></pre>
      <p> </p>
    </section>
    <section>
      <h1 id="Context">The Context class</h1>
      <p>A Context is the full set of all that a CGI endpoint knows about&nbsp; Request beside its URI. Context space
        contains system environment variables, requests header, request body, server specific vars, cookies, variables
        in configuration files, local define variables, etc etc..<br>
      </p>
      <p>Context variables are grouped in <em>namespaces</em>.<code> BOTK\Context\Context</code> class provide the
        method&nbsp; <code> ns(<var>namespace name</var>)</code> to access name spaces. There are five predefined
        namespaces: </p>
      <ul>
      </ul>
      <ol>
        <li> the variables defined in the heading of the request and exposed by web server (<var>INPUT_SERVER</var>); </li>
        <li> the variables encoded in http URI (<var>INPUT_GET</var><var></var>); </li>
        <li>the variables encoded in http body (<var>INPUT_POST</var>);</li>
        <li> the system environment (<var>INPUT_ENV</var>); </li>
        <li>local defined variables (Context::LOCAL). </li>
      </ol>
      <ul>
      </ul>
      <p>Beside these, Context class allow you to define dynamic namespace built from .ini files loaded runtime from a
        configuration directory. The name of the namespace is the name of the configuration file without .ini extension.</p>
      <p> The configuration file must exists when is first referenced. The default configuration directory is
        ../configs, that normally is a directory placed at the same level of the directory that contains the scripts who
        instance a context class. You can change the default directory defining the environment variable <var>$_ENV['BOTK_CONFIGDIR']</var>.
      </p>
      <p>Context shold be considered as a readonly data structure because you cant change the resource execution
        context.</p>
      <p> For example suppose to have a end-point script is in <code> myapp/httdocs/index.php </code> so, to get a
        success on following code, it must exist <code> myapp/configs/sample.ini </code> file: </p>
      <pre><code>use BOTK\Context\Context as CX;
$sampleNameSpace = CX::factory()-&gt;ns('sample');
</code></pre>
      <p> If you want to put the .ini file in the same end-point directory: </p>
      <pre><code>use BOTK\Context\Context as CX;
$_ENV['BOTK_CONFIGDIR'] = '.';
$sampleNameSpace = CX::factory()-&gt;ns('sample');
</code></pre>
      <p> You can also access to local variable passing them to context constructor: </p>
      <pre><code>$myvar = 'ok'; // define a variable in local scope
$v = CX::factory(get_defined_vars())-&gt;ns(CX::LOCAL)-&gt;getValue('myvar');
//$v == 'ok'
</code></pre>
      <p>Context class exposes the method <code>guessRequestCanonicalUri()</code> that returns the current request uri
        in canonical form and the method <code>guessRequestRelativelUri()</code> that returns it as relative path. </p>
      <p>Please note that get request uri is not a trivial job, this because http servers and proxyes can change what
        the user entered. You can just guess about it.</p>
      <h1 id="ContextNameSpace">The ContextNameSpace Class</h1>
      <p>This class implements the controlled access to set of variables.</p>
    </section>
    <section>
      <h2 id="ContextNameSpace">The getValue() method</h2>
      <p> The <code>BOTK\Context\ContextNameSpace</code> class exports the method <code> getValue() </code> that
        allows to validate and sanitize variables defined in a namespace (see <a href="http://foaa.de/blog/2012/11/27/php-validation-and-sanitization/">PHP
          Validation &amp; Sanitization</a> article). </p>
      <p> If somethings goes wrong it throwns an error that can be trapped by standard BOTK error management. </p>
      <p> <code>getValue()</code> exposes following interface: </p>
      <pre>  param string $varName       the name of a variable defined in the namespace
  param mixed  $default       a default value if variable is not set. NULL means that
                              the variable is mandatory.
  param mixed  $validator     Can be:
                                1) null use default validation
                                2) an integer representing a simple Validate filter without flags and options
                                3) an array representing a Validate filter with flags and/or options
                                4) an instance of an object that expose function 'assert'.
                                   you can use istance of Respect\Validation\Validator
  param mixed  $sanitizer     Can be:
                                A) null if no sanitization is required
                                B) an integer representing a simple Sanitize filter without flags and options
                                C) an array representing a Sanitize filter with flags and/or options
                                D) a callable that accept an argument (the source) and return sanitized one 
 
 throws InvalidArgumentException if $varName is not defined and $default not provided
 throws Exception if validator fails to validate variable (depending from the validator)
 throws InvalidArgumentException if sanitize fails
 
 return mixed the sanitized value associated to varName in namespace
 
 LIMITS:
  sanitizer are supported just on scalar values
  non scalar value require a custom validator like Respect\Validator
 
</pre>
      <p> In addition to <code>getValue()</code> <code>ContextNameSpace</code> class expose a set of shortcuts for
        easy to read and write code. </p>
      <h3 id="getValueShortcuts">validator shortcucts</h3>
      <p>Some validators shold be boring to write, here are a set of predefined shortcuts:</p>
      <pre>     public static function ENUM($wlist)
     {
         return  array(
                'filter'    =&gt; FILTER_VALIDATE_REGEXP,
                'options'   =&gt; array('regexp' =&gt; "/^($wlist)$/")
         );
     }
     
     public static function STRING($pattern)
     {
         return  array(
                'filter'    =&gt; FILTER_VALIDATE_REGEXP,
                'options'   =&gt; array('regexp' =&gt; $pattern)
         );
     }

     public static function FILENAME()
     {
         return  array(
                'filter'    =&gt; FILTER_VALIDATE_REGEXP,
                'options'   =&gt; array('regexp' =&gt; '^[\w,\s-]+\.[A-Za-z]+$')
         );
     }  


     public static function POSITIVE_INT()
     {
         return  array(
                'filter'    =&gt; FILTER_VALIDATE_INT,
                'options'   =&gt; array("min_range"=&gt;1)
         );
     }


     public static function NON_NEGATIVE_INT()
     {
         return  array(
                'filter'    =&gt; FILTER_VALIDATE_INT,
                'options'   =&gt; array("min_range"=&gt;0)
         );
     }  </pre>
      <p><br>
      </p>
      <h3 id="getValueShortcuts">getValue shortcucts</h3>
      <p>Even with validator shortcuts, a call to getValue method can be too verbose, here are some shortcut you can use
        for common task:</p>
      <ul>
        <li><span style="font-weight: bold;">getString</span>($varName,$default = null):&nbsp; same as
          getValue($varName,$default, null, FILTER_SANITIZE_STRING);</li>
        <li><span style="font-weight: bold;">getURI</span>($varName,$default = null):&nbsp; same as
          getValue($varName,$default, self::STRING('/.+/'), FILTER_SANITIZE_URL)</li>
      </ul>
      <p><br>
      </p>
      <h1 id="PagedResource">PagedResourceContext class</h1>
      <p>The PagedResource class is a facility to manage the context of a resource whose query string can contains
        variables to drive pagination processing. It is a specialization of Context class and like Context should be
        considered as a read-only data structure.</p>
      The resource paging context is inspired on W3C's Linked Data Platform Paging specifications .Here are some
      imported definitions:<br>
      <dl class="glossary">
        <dt><dfn>Paged resource</dfn></dt>
        <dd>A resource&nbsp; whose representation may be too large to fit in a single HTTP response, for which a server
          offers a sequence of single-page resources. A paged <var>P</var> is broken into a sequence of pages
          (single-page resources) <var>P<sub>1</sub>, P<sub>2</sub>, ...,P<sub>n</sub></var>, the representation of
          each <var>P<sub>i</sub></var> contains a subset of&nbsp; <var>P</var>.. </dd>
        <dt><dfn>Single-page resource</dfn></dt>
        <dd>One of a sequence of related resources <var>P<sub>1</sub>, P<sub>2</sub>, ...,P<sub>n</sub></var>, each of
          which contains a subset of the state of another resource <var>P</var>. <var>P</var> is called the paged
          resource. For readers familiar with paged feeds, a single-page resource is similar to a feed document and the
          same coherency/completeness considerations apply.
          <p> Note: the choice of terms was designed to help authors and readers clearly differentiate between the <a title="Paged resource"><em>resource
                being paged</em></a>, and the <a title="Single-page resource"><em>individual page resources</em></a>,
            in cases where both are mentioned in close proximity. </p>
        </dd>
        <dt><dfn>first page <br>
          </dfn></dt>
        <dd>The uri to the first <a style="text-decoration: underline;" title="Single-page resource">single-page
            resource</a> of a <a title="Paged resource">paged resource</a> <var>P</var>. For example
          http://www.example.org/bigresource?page=0 </dd>
        <dt><dfn>next page <br>
          </dfn></dt>
        <dd>The uri&nbsp; to the next <a title="Single-page resource">single-page resource</a> of a <a title="Paged resource">paged
            resource</a> <var>P</var>. </dd>
        <dt><dfn>last page<br>
          </dfn></dt>
        <dd>The uri&nbsp; to the last <a title="Single-page resource">single-page resource</a> of a <a title="Paged resource">paged
            resource</a> <var>P</var>. </dd>
        <dt><dfn>previous page <br>
          </dfn></dt>
        <dd>The uri&nbsp; to the previous <a title="Single-page resource">single-page resource</a> of a <a title="Paged resource">paged
            resource</a> <var>P</var>. </dd>
      </dl>
      <p>Pagination require some variable to be specified in resource URI query strings. Such variables name and other
        default values can be passed to class constructor as an option associative array. Here are supported keywords:</p>
      <ul>
        <li>plabel : contains the variable that contains page num. For default 'page'</li>
        <li> pslabel&nbsp; : contains the variable that contains page size. For default 'pagesize</li>
        <li>pagesize&nbsp; : contains the default value for page size. The default is 100<br>
        </li>
      </ul>
      <p>It exposes following methods:</p>
      <dl>
        <dt><code>getSinglePageResourceUri( $pagenum = null, $pagesize=null)</code></dt>
        <dd>returns the canonical uri with page variables in query string. Without arguments returns current page
          resource uri</dd>
        <dt><code>getPagedResourceUri()</code></dt>
        <dd>return the resource uri wit page variables removed from query string&nbsp; </dd>
        <dt><code>isPagedResource()</code></dt>
        <dd>returns true is resource uri contains page info</dd>
        <dt><code>getPageNum()</code></dt>
        <dd>returns the current page num</dd>
        <dt><code>getPageSize()</code></dt>
        <dd>returns the size of the page</dd>
        <dt><code>firstPageUri()</code></dt>
        <dd>returns the Resource uri for first Single page resource</dd>
        <dt><code>nextPageUri()</code></dt>
        <dd>returns the Resource uri for next page resource or the current page resource uri</dd>
        <dt><code>prevPageUri()</code></dt>
        <dd>returns the Resource uri for next page resource or the first page resource uri</dd>
        <dt><code>hasNextPage()</code></dt>
        <dd>returns true if a next page is available. By default returns true. It can be affected by <code>declareActualPageSize()</code>
          method</dd>
        <dt><code>isLastPage()</code> </dt>
        <dd>returns true if the current is the last page. By default returns false. It can be affected by <code>declareActualPageSize()</code>
          method</dd>
        <dt><code>declareActualPageSize($count)</code></dt>
        <dd>inform context of the number of item in current Page, by default is 0. This affects <code>hasNextPage()</code>
          and <code>isLastPageMethods()</code>.</dd>
      </dl>
      <p>Here is how <code>declaretActualPageSize()</code> affects <code>hasNextPage()</code> and <code>isLastPage()</code>:</p>
      <pre>    function hasNextPage(){
         return actualPageSize == $this-&gt;pagesize;
    }
      
    function isLastPage(){
          return actual PageSize &lt; $this-&gt;pagesize;
    }</pre>
      <dl>
      </dl>
      <p><br>
      </p>
      <p> </p>
    </section>
    <footer>
      <!-- __FOOTER --> </footer>
  </body>
</html>
